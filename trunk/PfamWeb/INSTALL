
PfamWeb
jt6 20070302 WTSI.

This is the INSTALL file for the PfamWeb website application. It details the 
process of installing PfamWeb using the Build.PL installation script and lists
some starting points for reading about Catalyst.

This file, like all of the others in this distribution, is a work in progress...

Contents
========

o Installation overview
o Documentation
o Longer explanation of the install process
  - Prerequisites
    + Module::Build
    + Catalyst::Runtime
    + mod_perl
  - Running the build script
  - Questions
  - Build
  - Install
  - Configure Apache
  - Browse
o Known bugs
	
Installation overview
=====================

Run the installation script and answer the questions:

	$ perl Build.PL
	...

Run the Build script:

	$ ./Build
	...

Install the PfamWeb code:

	$ ./Build install

Add the PfamWeb config to your Apache:

	$ echo Include /path-to-pfamweb/httpd.conf >> /path-to-your-apache/httpd.conf	

Restart Apache:

	$ /path-to-apache-root/bin/apachectl restart
	
Browse to:

	http://your-server/catalyst/pfam

Documentation
=============

Installing Catalyst is a task in and of itself and there are some good
resources on the web that describe it. 

o The main CPAN documentation for Catalyst:

		http://search.cpan.org/dist/Catalyst-Manual/

	This includes a (short) section on installation which suggests using an
	installation script from: 
	
		http://www.shadowcatsystems.co.uk/projects/catalyst/index.html

o Catalyst mailing list archives:

	http://www.mail-archive.com/catalyst@lists.rawmode.org/

o There's a thread on the mailing list specifically about Catalyst installation

	  http://www.mail-archive.com/catalyst@lists.rawmode.org/msg01162.html
	
	which probably covers a lot of ground, but it's a painful read...

Longer explanation of the install process
=========================================

Prerequisites
-------------

Module::Build

The build and installation process absolutely requires Module::Build (M::B) to
be installed in your default perl executable:

	$ perl -e 'use Module::Build'

This shouldn't really be a problem because many of the Catalyst prerequisites
use M::B themselves, so it should already be installed by the time you come to
install PfamWeb.

Installing M::B has proven annoyingly difficult when we've done it previously.
This is mainly because we haven't been installing as root, so we're trying to
install into a location which it doesn't expect. If you have problems installing
M::B itself, please let us know and we'll try to help.


Catalyst::Runtime

After M::B is installed, you can go ahead with the PfamWeb installation, using 
the included build script. That script includes a list of prerequisites for
PfamWeb and will generate an error message if you try to install without first
having installed those perl dependencies. Note that the script doesn't make any
attempt to install the prerequisites for you, as would be the case if you were
installing a true perl module - it's just not that helpful.

After M::B, the next most obvious prerequisite for running a Catalyst web-
application is Catalyst itself. Installing Catalyst has been, in our experience,
more painful that installing PfamWeb, due largely to the number of prerequisites
for Catalyst.

There are two ways to install Catalyst:

	o use a Catalyst installation script (see the Documentation links above)
	o configure CPAN and install Catalyst::Runtime using the CPAN shell

We've never tried an installation script, but lots of people on the Catalyst
mailing list have had success with it. For various reasons, we've installed
Catalyst and its prerequisites using the CPAN shell and have had to nurse the
process all the way, identifying the cause of installation failures and fixing
any problems that arise along the way.

Installing Catalyst using CPAN will allow you to install the chains of 
dependencies for Catalyst, but you'll need to install the prerequisites for
PfamWeb itself "manually". That is, the installation script knows what its
dependencies are but doesn't attempt to install them like a true perl module
installation would.

The following is a list of the known prerequisites for PfamWeb. It's likely
to be an incomplete list, so you may find that others are requires when you
try to start the server. If you do find missing dependencies, please keep a note
of them and let us know, so that we can add them to this list for the future:

  Bio::Das::Lite
  Catalyst::Runtime
  Catalyst::Action::RenderView
  Catalyst::Model::DBIC::Schema
  Catalyst::Plugin::Cache::FastMmap
  Catalyst::Plugin::Email
  Catalyst::Plugin::HTML::Widget
  Catalyst::Plugin::Session::State::Cookie
  Catalyst::Plugin::Session::Store::FastMmap
  Class::Data::Accessor
  Config::General
  DateTime
  DBIx::Class
  DBIx::Class::HTMLWidget
  GD
  GD::Graph
  HTML::Tree
  HTML::Widget
  JSON
  LWP::Parallel::UserAgent
  SOAP::Data::Builder
  XML::Feed

mod_perl

We run Catalyst using the mod_perl plugin for Apache. You will need to have
mod_perl installed and running before trying to restart Apache to run PfamWeb.
The instructions for installing mod_perl can be found at the main mod_perl
site at:

  http://perl.apache.org/docs/2.0/user/index.html

Running the build script
------------------------

Using M::B is similar to using configure and make. Instead of a script called
"configure", there is a script called "Build.PL" which generates a file called
"Build, in the same way that "configure" generates "Makefile". You run Build.PL
something like:

	$ perl Build.PL
	...

The script will then ask a series of questions and based on your responses it
will configure and write out two new files, pfamweb.conf and httpd.conf. The
first file is an internal configuration file that's used by PfamWeb. The second
is a snippet of Apache configuration that needs to be included somewhere in the
config for your webserver.

Questions
---------

The questions that are asked by the Build.PL script are mostly related to
where things will ultimately live, but some are a bit obscure...

"Where is the default PfamWeb/Apache configuration file ?"

The distribution comes with two template config files, which are used to provide
the default answers to the rest of the questions. The script is hard-coded
to look inside the distribution directory for the starting templates, but we
ask this question so that you can make changes to the files and then keep 
copies separately from the distribution. This is so that later, if you need to
re-install or upgrade, you can point to your modified versions of the files and
you'll get starting values from your files rather than ours.

"In what directory do you want to install the PfamWeb application ?"

This is a single directory into which we'll install all of the PfamWeb files.
It can live more or less anywhere, as long as your Apache can serve files from
this directory. Because we modify the files in the distribution during the
installation process, you should put this directory outside of the distribution
directory. 

"What is the application root for your site ?"

PfamWeb needs to know where it is running, relative to the root URL for your
Apache server, so that URLs in dynamic pages can be build correctly. We also
need to configure mod_perl to dispatch PfamWeb URLs to PfamWeb classes. This
value should be just the path part of the URL. For example, our internal
development servers are accessed using this URL:

	http://deskpro12345.dynamic.sanger.ac.uk:8000/catalyst/pfam

The application root in this case is "/catalyst/pfam". Be sure not to include
an extra slash at the end of the path, because that changes the meaning of
the URL as far as Catalyst is concerned.

"What is the absolute path for the temporary directory ?"

Some parts of the PfamWeb application write temporary files. The domain graphics
are the most obvious example. These files are only required for the lifetime of
a single request so they can be placed in a directory which is frequently
cleaned. Right now it's important that the directory is always present though -
don't let a cron job delete it entirely, otherwise something will fail when it
tries to write to it.

Also, it's important that the temp directory is visible from the web, so we 
also ask for the URL for it. That will be prepended onto paths for temporary
files, such as the graphics.

"What is the name of the Pfam database ? etc"

We obviously need to connect to the Pfam database to retrieve data, so we ask
for all of the connection parameters that we need. We assume that you're
connecting to the Pfam DB using a read-only account, which is just good practice
for web-applications. If you have to specify a password, mail us and we'll
explain how to add one. 

As well as the Pfam DB, we also use a small tracking database, to which we 
require read/write access. This time we'll ask for a username and password.

Once you've given all the DB connection parameters, the script will offer to 
try connecting to the DBs. This is just a quick DBI connection, so it should be
a semi-sensible test of the values you've given. If for any reason the
connection test fails, you should be allowed to re-enter the connection 
parameters, but you should also be able to simply accept them and fix things
later if you prefer.

"Where should we put the contents of the pfamCore directory ?"

As well as the PfamWeb code, the distribution includes two directories, 
pfamCore and pfamModel, which are two CVS modules containing extra classes
that we use. Although they're bundled with the PfamWeb code in the distribution,
these two directories are kept as two separate modules in WTSI and the script
will ask for two separate locations.

"Where is the muscle binary ?"

We use muscle in the PfamWeb code and we've bundled a linux binary with this
distribution. We need to know where it will eventually be installed, so that we
can configure the application to find it when it's running. You can copy the 
linux binary from the distribution and install it somewhere appropriate or, if
you already have an installed version, point to that one when asked for the
muscle binary location.

Build
-----

After running "perl Build.PL" you should have a file called "Build" in the top
level distribution directory. Running Build will copy and edit the files from
the distribution, customising them according the answers that you gave earlier:

	$ ./Build
	...
	
You should see a long list of source files, along with their temporary
destination inside the distribution directory.

Install
-------

Finally, you need to run the install step. Before doing that you may want to 
check that the configuration is correct, which you can do by running:

	$ ./Build fakeinstall
	
This will display the operations that will be performed by the installation, but
will not modify or move any files. If the list of final destinations for files 
looks correct, you can run the installation proper by doing:

	$ ./Build install
	
You should see the same list of files as for "fakeinstall", but this time they
will be moved into their final locations, as you specified earlier. 

Configure Apache
----------------

In the directory where you installed PfamWeb, you will find "conf/httpd.conf",
the snippet of Apache configuration that is required to configure mod_perl and
PfamWeb. To complete the installation, that configuration needs to be added to
the configuration for your mod_perl-enabled Apache server.

You can either add the contents of that file directly to the 
httpd.conf for the server, or you can add an "Include" directive that will
point to that file:

	$ echo Include /path-to-pfamweb/httpd.conf >> /path-to-your-apache/httpd.conf	

Restart the server to load PfamWeb. All messages generated by Catalyst are sent
to "error.log", so you should see something like this at the end of the log
file: 

	...
	| /structure/graphics                 | /structure/graphics/default          |
	| /structure/structuraldomains        | /structure/structuraldomains/getStr- |
	|                                     | ucturalDomains                       |
	| /structure/structuraldomains        | /structure/structuraldomains/default |
	| /structure/viewer                   | /structure/viewer/default            |
	'-------------------------------------+--------------------------------------'

	[debug] Loaded Regex actions:
	.-------------------------------------+--------------------------------------.
	| Regex                               | Private                              |
	+-------------------------------------+--------------------------------------+
	| ^speciesdistribution/(P\S{1}\d{5,7- | /speciesdistribution/getSpeciesDist- |
	| })                                  | ribution                             |
	'-------------------------------------+--------------------------------------'

	[info] PfamWeb powered by Catalyst 5.7006
	[Wed Feb 28 10:14:58 2007] [notice] Apache/2.2.3 (Unix) mod_perl/2.0.2 Perl/v5.8.7 configured -- resuming normal operations

If there is a problem, the Catalyst error messages will also appear here.

Browse
------

To test the site you need to visit the URL for the index page of PfamWeb. That
URL is made up of the site address and the application root that you specified
during the installation. 

As an example, we run test servers on our desktop linux machines, which are
labelled something like deskpro12345. The internal address for those machines
looks like:

	deskpro12345.dynamic.sanger.ac.uk

Because we don't run our development servers as root, we have to serve from a 
port higher than 1024, so we default to port 8000, making the base URL for an
Apache server on our desktop machines:

	http://deskpro12345.dynamic.sanger.ac.uk:8000

The path part of the URL is given during installation and the installation
script will actually tell you what the URL should look like when you run it. 
For example, when asked "what is the application root for your site ?", we
would specify "/catalyst/pfam", so the index page for our installation would be:

	http://deskpro12345.dynamic.sanger.ac.uk:8000/catalyst/pfam
	
Browsing to that URL should show the index page for the site. If it doesn't,
either the URL is wrong or there is a problem... Check "error.log" for messages
from Catalyst and let us know that there was a problem with the installation !

Known bugs
==========

o There are several components of the site which are currently served directly
  from our local disks. One example is the relationship images for clans. We 
  intend to drop all of these files into the Pfam database, so that they can de
  downloaded with the rest of the data but, for now, you'll have missing
  images in the pages and error messages in the logs for these components.
  
o The list of prerequisites in the top of the Build.PL script is almost 
  certainly incomplete.

o The Build.PL script is certain to have bugs, but I don't know what they are.
  It's only been tested locally in Sanger and although it works for us I'm sure
  there will be some bad assumption or missing file that will cause problems on
  remote sites. Please let me know of any and all problems that you have,
  preferably with a log of what went on prior to the problem !



$Id: INSTALL,v 1.3 2007-03-02 16:26:34 jt6 Exp $
