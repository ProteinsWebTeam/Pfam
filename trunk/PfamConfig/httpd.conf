
ServerRoot "/var/httpd"
Listen 8000

ServerAdmin jt6@sanger.ac.uk

DocumentRoot "/var/httpd/htdocs"

<Directory />
    Options FollowSymLinks
    AllowOverride None
    Order deny,allow
    Deny from all
</Directory>

<Directory "/var/httpd/htdocs">
    Options Indexes FollowSymLinks
    AllowOverride None
    Order allow,deny
    Allow from all
</Directory>

<IfModule dir_module>
    DirectoryIndex index.html
</IfModule>

<FilesMatch "^\.ht">
    Order allow,deny
    Deny from all
    Satisfy All
</FilesMatch>

ErrorLog logs/error_log

LogLevel warn

<IfModule log_config_module>
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
    LogFormat "%h %l %u %t \"%r\" %>s %b" common
    CustomLog logs/access_log common
</IfModule>

<IfModule alias_module>
    ScriptAlias /cgi-bin/ "/var/httpd/cgi-bin/"
</IfModule>

<Directory "/var/httpd/cgi-bin">
    AllowOverride None
    Options None
    Order allow,deny
    Allow from all
</Directory>

DefaultType text/plain

<IfModule mime_module>
    TypesConfig conf/mime.types
    AddType application/x-compress .Z
    AddType application/x-gzip .gz .tgz
</IfModule>

#--------------------------------------------------------------------------------
# configure catalyst

# first, load mod_perl into apache
LoadModule perl_module modules/mod_perl.so

#----------------------------------------
# next, set some environment variables for perl - mostly used by drawing code

# the location of temporary files for the drawing code
PerlSetEnv PFAM_DOMAIN_IMAGES  /var/httpd/htdocs/tmp/pfam

# the full path to the muscle binary
PerlSetEnv PFAM_MUSCLE_BIN    /usr/local/bin/muscle

# the base location for the application
PerlSetEnv PFAM_FAMILY_ROOT    /catalyst/PfamWeb

# the location of the main catalyst configuration file
PerlSetEnv PFAMWEB_CONFIG    /var/httpd/conf/pfamweb.conf

# enable DBIx::Class debug messages; adds SQL statements to the error log
#PerlSetEnv DBIC_TRACE 1

#----------------------------------------
# set up the libraries that we'll need... we should be able to add -wT here but
# that stops everything working...

PerlSwitches -wT \
             -I/var/server/PfamLib \
             -I/var/PfamSchemata \
             -I/var/PfamWeb/lib

# if we ditch the startup.pl file, we can load the application module here
#PerlModule PfamWeb

PerlRequire     /var/httpd/conf/startup.pl

#----------------------------------------
# rewrite rules

# these are required to allow apache to catch requests for the static content. 
# We use mod_rewrite to modify the URLs to point to /sideways and then alias 
# folders in that location to the correct ones in the PfamWeb application tree

LoadModule  rewrite_module modules/mod_rewrite.so
RewriteEngine  on
RewriteRule  /catalyst/(PfamWeb/javascripts.*)  /sideways/$1  [PT,L]
RewriteRule  /catalyst/(PfamWeb/css.*)          /sideways/$1  [PT,L]
RewriteRule  /catalyst/(PfamWeb/images.*)       /sideways/$1  [PT,L]
RewriteRule  /catalyst/(PfamWeb/av.*)           /sideways/$1  [PT,L]
RewriteRule  /catalyst/(PfamWeb/jalview.*)      /sideways/$1  [PT,L]
RewriteRule  /catalyst/(PfamWeb/jmol.*)         /sideways/$1  [PT,L]

Alias /sideways/PfamWeb/javascripts  /var/httpd/PfamWeb/htdocs/javascripts
Alias /sideways/PfamWeb/css          /var/httpd/PfamWeb/htdocs/css
Alias /sideways/PfamWeb/images       /var/httpd/PfamWeb/htdocs/images
Alias /sideways/PfamWeb/av           /var/httpd/PfamWeb/htdocs/av
Alias /sideways/PfamWeb/jalview      /var/httpd/PfamWeb/htdocs/jalview
Alias /sideways/PfamWeb/jmol         /var/httpd/PfamWeb/htdocs/jmol

# add a rewrite rule to add a trailing slash to URIs without them
RewriteRule ^/catalyst/PfamWeb$ catalyst/PfamWeb/ [R]

#----------------------------------------
# serve up stuff in the PfamWeb static tree

<Directory /nfs/team71/pfam/jt6/server/PfamWeb/htdocs>
  Options  none
  Order  allow,deny
  Allow  from all
</Directory>

#----------------------------------------
# finally, set up the application as a handler for the base location

<Location /catalyst/PfamWeb>
    SetHandler    perl-script
    PerlResponseHandler  PfamWeb
</Location>
