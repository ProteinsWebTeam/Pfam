
# httpd.conf
# jt6 20080320 WTSI.
#
# An example apache configuration file.
#
# $Id: httpd.conf,v 1.2 2008-05-16 15:02:39 jt6 Exp $

# Copyright (c) 2007: Genome Research Ltd.
#
# Authors: Rob Finn (rdf@sanger.ac.uk), John Tate (jt6@sanger.ac.uk)
#
# This is free software; you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free Software
# Foundation; either version 2 of the License, or (at your option) any later
# version.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
# details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <http://www.gnu.org/licenses/>.

ServerRoot "/var/httpd"
Listen 8000

ServerAdmin admin@your-site.org

DocumentRoot "/var/httpd/htdocs"

<Directory />
    Options FollowSymLinks
    AllowOverride None
    Order deny,allow
    Deny from all
</Directory>

<Directory "/var/httpd/htdocs">
    Options Indexes FollowSymLinks
    AllowOverride None
    Order allow,deny
    Allow from all
</Directory>

<IfModule dir_module>
    DirectoryIndex index.html
</IfModule>

<FilesMatch "^\.ht">
    Order allow,deny
    Deny from all
    Satisfy All
</FilesMatch>

ErrorLog logs/error_log

LogLevel warn

<IfModule log_config_module>
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
    LogFormat "%h %l %u %t \"%r\" %>s %b" common
    CustomLog logs/access_log common
</IfModule>

<IfModule alias_module>
    ScriptAlias /cgi-bin/ "/var/httpd/cgi-bin/"
</IfModule>

<Directory "/var/httpd/cgi-bin">
    AllowOverride None
    Options None
    Order allow,deny
    Allow from all
</Directory>

DefaultType text/plain

<IfModule mime_module>
    TypesConfig conf/mime.types
    AddType application/x-compress .Z
    AddType application/x-gzip .gz .tgz
</IfModule>

#--------------------------------------------------------------------------------
# configure catalyst

# first, load mod_perl into apache
LoadModule perl_module modules/mod_perl.so

#----------------------------------------
# next, set some environment variables for perl - mostly used by drawing code

# the location of temporary files for the drawing code
PerlSetEnv PFAM_DOMAIN_IMAGES /var/httpd/htdocs/tmp/pfam

# the base location for the application
PerlSetEnv PFAM_FAMILY_ROOT   /catalyst/pfam

# the location of the main catalyst configuration file
PerlSetEnv PFAMWEB_CONFIG     /var/httpd/conf/pfamweb.conf

# enable DBIx::Class debug messages; adds SQL statements to the error log
#PerlSetEnv DBIC_TRACE 1

#----------------------------------------
# set up the libraries that we'll need... we should be able to add -wT here but
# that stops everything working...

PerlSwitches -wT \
             -I/var/httpd/PfamLib \
             -I/var/httpd/PfamSchemata \
             -I/var/httpd/PfamWeb/lib

# if we ditch the startup.pl file, we can load the application module here
#PerlModule PfamWeb

#----------------------------------------
# rewrite rules

# these are required to allow apache to catch requests for the static content. 
# We use mod_rewrite to modify the URLs to point to /sideways and then alias 
# folders in that location to the correct ones in the PfamWeb application tree

LoadModule  rewrite_module modules/mod_rewrite.so
RewriteEngine  on
RewriteRule  /catalyst/(pfam/javascripts.*)  /sideways/$1  [PT,L]
RewriteRule  /catalyst/(pfam/css.*)          /sideways/$1  [PT,L]
RewriteRule  /catalyst/(pfam/images.*)       /sideways/$1  [PT,L]
RewriteRule  /catalyst/(pfam/av.*)           /sideways/$1  [PT,L]
RewriteRule  /catalyst/(pfam/jalview.*)      /sideways/$1  [PT,L]
RewriteRule  /catalyst/(pfam/jmol.*)         /sideways/$1  [PT,L]

Alias /sideways/pfam/javascripts  /var/httpd/pfam/htdocs/javascripts
Alias /sideways/pfam/css          /var/httpd/pfam/htdocs/css
Alias /sideways/pfam/images       /var/httpd/pfam/htdocs/images
Alias /sideways/pfam/av           /var/httpd/pfam/htdocs/av
Alias /sideways/pfam/jalview      /var/httpd/pfam/htdocs/jalview
Alias /sideways/pfam/jmol         /var/httpd/pfam/htdocs/jmol

# add a rewrite rule to add a trailing slash to URIs without them
RewriteRule ^/catalyst/pfam$ catalyst/pfam/ [R]

#----------------------------------------
# serve up stuff in the PfamWeb static tree

<Directory /var/httpd/PfamWeb/root/static>
  Options  none
  Order  allow,deny
  Allow  from all
</Directory>

#----------------------------------------
# finally, set up the application as a handler for the base location

<Location /catalyst/pfam>
    SetHandler          perl-script
    PerlResponseHandler PfamWeb
</Location>
