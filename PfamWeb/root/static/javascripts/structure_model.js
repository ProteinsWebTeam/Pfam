const IP_PFAM_FAMILY_API = "https://www.ebi.ac.uk/interpro/wwwapi/entry/pfam/";
const IP_PFAM_FAMILY_WEB = "https://www.ebi.ac.uk/interpro/entry/pfam/";

const getInterProStructureModelLink = async function(accession) {
  const url = new URL(accession, IP_PFAM_FAMILY_API);
  let promise = fetch(url);
  let response = await(promise);
  if (response.ok) {
    const json = await response.json();
    if (json?.metadata?.counters?.structural_models > 0) {
      addStructureTabToPage(accession);
    }
  } else {
    console.log("WARNING: Failed to fetch " + url);
  }
};

const addStructureTabToPage = function(accession) {
  const structureModelId = "structureModelBlock";
  // create navigation link
  const structureModel = document.createElement("LI");
  structureModel.id = "structureModelSelector";
  const link = document.createElement("A");
  link.href = "#" + structureModelId;
  link.text = "Structure Model";
  structureModel.append(link);
  structureModel.addEventListener("click", () => {
    const structureModelContainer = document.getElementById(structureModelId);
    structureModelContainer.classList.remove("yui-hidden");
    structureModelContainer.title = "active";
  });

  // add to navigation link
  const structure = document.getElementById('pdbBlockSelector');
  if (structure) {
    structure.parentElement.appendChild(structureModel);

  }
  const url = new URL(`${accession}/model`, IP_PFAM_FAMILY_WEB);

  // create title
  const title = document.createElement("H1");
  title.innerHTML = "Structure Model";
  const titleContainer = document.createElement("DIV");
  titleContainer.classList.add("handle");
  titleContainer.appendChild(title);
  // create content

  const intro = document.createElement("P");
  intro.innerHTML = `A structural model is has been predicted for this Family.
  The model was generated by the
  <a href="https://www.bakerlab.org/">Baker</a> group with the trRosetta
  software based on the Pfam uniprot multiple sequence alignment`;
  const links = document.createElement("P");
  links.innerHTML = `
  <ul>
    <li><a href="${IP_PFAM_FAMILY_WEB}/${accession}/model">View the structural
    model in InterPro</a></li>
    <li><a href="${IP_PFAM_FAMILY_API}/${accession}/?model:structure"
    filename="${accession}_prediction.pdb">Download the model in PDB format</a></li>
    <li><a href="http://ftp.ebi.ac.uk/pub/databases/interpro/">View all the
    structural models at the InterPro FTP site</a></li>
  </ul>`;

  const textContainer = document.createElement("DIV");
  textContainer.classList.add("blockContent");
  textContainer.appendChild(intro);
  textContainer.appendChild(links);

  // create container for structure model divs
  const structureModelContainer = document.createElement("DIV");
  structureModelContainer.id = structureModelId;
  structureModelContainer.classList.add("block");
  structureModelContainer.classList.add("yui-hidden");
  structureModelContainer.appendChild(titleContainer);
  structureModelContainer.appendChild(textContainer);

  // add to doc
  const detailsContainer = document.getElementById("content");
  if (detailsContainer) {
    detailsContainer.appendChild(structureModelContainer);
  }
};

const fetchStructureModel = function(accession) {

};
