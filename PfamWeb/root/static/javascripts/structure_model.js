const IP_PFAM_FAMILY_API = "https://www.ebi.ac.uk/interpro/wwwapi/entry/pfam/";
const IP_PFAM_FAMILY_WEB = "https://www.ebi.ac.uk/interpro/entry/pfam/";

const getInterProStructureModelLink = async function(accession) {
  const url = new URL(accession, IP_PFAM_FAMILY_API);
  let promise = fetch(url);
  let response = await(promise);
  if (response.ok) {
    const json = await response.json();
    if (json?.metadata?.counters?.structural_models > 0) {
      addStructureTabToPage(accession);
    }
  } else {
    console.log("WARNING: Failed to fetch " + url);
  }
};

const addStructureTabToPage = function(accession) {
  const structureModelId = "tabview=tab9";
  const structureModelSelectorId = "structureModelSelector"
  // create navigation link
  const structureModelSelector = document.createElement("LI");
  structureModelSelector.id = structureModelSelectorId;
  const link = document.createElement("A");
  //link.href = "#" + structureModelId;
  link.text = "Structural Model";
  structureModelSelector.append(link);

  // add to navigation link
  const structure = document.getElementById('pdbBlockSelector');
  const sidebar = document.getElementById("sidebar");
  if (structure && sidebar) {
    structure.parentElement.appendChild(structureModelSelector);
    sidebar.addEventListener("click", (e) => {
      e.preventDefault();
      const target = e.target.parentElement;
      const selectors = target.parentElement.children;
      const structureModelSection = document.getElementById(structureModelId);
      if (target.id === structureModelSelectorId) {
        //container.style.visibility = "visible";
        const content = document.getElementById("content").children;
        for (const section of content) {
          if (section.id != structureModelSelectorId) {
            section.classList.add("yui-hidden");
          }
        }
        structureModelSection.classList.remove("yui-hidden");
        structureModelSection.title = "active";
        for (const selector of selectors) {
            selector.classList.remove("selected");
            selector.title = null;
            target.title = "active";
            target.classList.add("selected");
        }
      } else {
        //container.style.visibility = "hidden";
        structureModelSection.classList.add("yui-hidden");
        structureModelSection.title = null;
        const selector = document.getElementById(structureModelSelectorId);
        selector.classList.remove("selected");
        selector.title = null;
      }

    });
  }
  const url = new URL(`${accession}/model`, IP_PFAM_FAMILY_WEB);

  // create container for structure model divs
  const structureModelContainer = document.createElement("DIV");
  structureModelContainer.id = structureModelId;
  structureModelContainer.classList.add("block");
  addStructureModelContent(structureModelContainer, accession);

  // add to doc
  const detailsContainer = document.getElementById("content");
  if (detailsContainer) {
    detailsContainer.appendChild(structureModelContainer);
  }
  if (structureModelSelector.classList.contains("selected")) {
    //structureModelContainer.style.visibility = "visible";
    structureModelContainer.classList.remove("yui-hidden");
  } else {
    //structureModelContainer.style.visibility = "hidden";
    structureModelContainer.classList.add("yui-hidden");
  }
  /*
  var stage = new NGL.Stage("viewport");
  stage.loadFile(
    "https://www.ebi.ac.uk/interpro/wwwapi//entry/pfam/PF12890/?model%3Astructure="
  ).then(function (component) {
    component.addRepresentation('cartoon');
    component.autoView();
  });
*/
};

const addStructureModelContent = function(structureModelContainer, accession) {
  // create title
  const titleContainer = createTitle();
  // create content
  const textContainer = createContainer(accession);
  // add both to supplied element
  structureModelContainer.appendChild(titleContainer);
  structureModelContainer.appendChild(textContainer);
}

const createTitle = function() {
  const title = document.createElement("H1");
  title.innerHTML = "Structural Model";
  const titleContainer = document.createElement("DIV");
  titleContainer.classList.add("handle");
  titleContainer.appendChild(title);
  return titleContainer;
}

const createContainer = function(accession) {
  const intro = document.createElement("P");
  intro.innerHTML = `A structural model was generated by the
  <a href="https://www.bakerlab.org/">Baker</a> group with the trRosetta
  software using the Pfam uniprot multiple sequence alignment`;

  /*
  const viewer = document.createElement("div");
  viewer.id = "viewport";
  viewer.style.width = "400px";
  viewer.style.height = "300px";
  */

  const links = document.createElement("P");
  links.innerHTML = `
  <ul>
    <li><a href="${IP_PFAM_FAMILY_WEB}/${accession}/model" target="_blank">View the structural
    model in InterPro</a></li>
    <li><a href="${IP_PFAM_FAMILY_API}/${accession}/?model:structure"
    filename="${accession}_prediction.pdb" target="_blank">Download the model in PDB format</a></li>
    <li><a href="http://ftp.ebi.ac.uk/pub/databases/Pfam/baker/" target="_blank">Download all the data from the Pfam FTP site</a></li>
  </ul>

  <div class="citation">
    <span class="title">
      <a class="ext" href="https://doi.org/10.1073/pnas.1914677117">
        Improved protein structure prediction using predicted interresidue
        orientations.
      </a>
    </span>
    <span class="authors">
      Jianyi Yang, Ivan Anishchenko, Hahnbeom Park, Zhenling Peng,
      Sergey Ovchinnikov, David Baker
    </span>
    <span class="ref">
      <span class="jrnl">Proceedings of the National Academy of Sciences</span>
      Jan 2020, 117 (3) 1496-1503;
      DOI: 10.1073/pnas.1914677117;
    </span>
  </div>`

  const textContainer = document.createElement("DIV");
  textContainer.classList.add("blockContent");
  textContainer.appendChild(intro);
  //textContainer.appendChild(viewer);
  textContainer.appendChild(links);
  return textContainer;
}

const fetchStructureModel = function(accession) {

};
